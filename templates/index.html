{% extends "base.html" %}{% block content %}

<a href="/login">管理者ログイン</a>
<a href="/admin">管理者画面</a>
<a href="https://github.com/newhonke/flask_bbs">github</a>
<form action="/" method="post">
    <label>投稿</label>
    <input type="text" name="note" required>
    <input type="hidden" name="reply_to" id="reply_to_input" value="">
    <div id="reply_info"></div>
    <button type="button" id="cancel_reply" style="display:none;">返信をキャンセル</button>
    <input type="submit" value="投稿">
</form>
{% for note in notes %}
    <div id="note-{{ note.id }}">
    {% if note.user and note.user.is_admin %}
        <p style="color: red;">{{ note.id }}</p>
    {% else %}
        <p>{{ note.id }}</p>
    {% endif %}

    {% if note.reply_to %}
        {% set parent = parent_map.get(note.reply_to) %}
        {% if parent %}
            返信元:<a href="#note-{{ parent.id }}">{{ parent.post }}</a>
        {% endif %}
    {% endif %}
    
    {% if note.renote_from_id %}
        {% set original = parent_map.get(note.renote_from_id) %}
        {% if original %}
            <p>リノートされました</p>
            <h3>{{ original.post }}</h3>
        {% else %}
            <p>リノート元は削除されています</p>
        {% endif %}
    {% else %}
        <h3>{{ note.post }}</h3>
    {% endif %}

    <small>({{ note.created_at | to_jst }})</small>

    
    {% if note.post and not note.renote_from_id %}
        <a href="#" class="reply-btn" data-reply-to="{{ note.id }}">返信</a>
        <form action="{{ url_for('renote', id=note.id) }}" method="post" style="display:inline;">
            <button type="submit">リノート</button>
        </form>
    {% endif %}
    <hr>
    </div>
{% else %}
<p>noteがありません。</p>    
{% endfor %}

<script>
const replyInput = document.getElementById("reply_to_input");
const replyInfo = document.getElementById("reply_info");
const cancelBtn = document.getElementById("cancel_reply");

document.querySelectorAll(".reply-btn").forEach(btn => {
    btn.addEventListener("click", e => {
        e.preventDefault();
        const id = btn.dataset.replyTo;
        replyInput.value = id;
        replyInfo.innerHTML = "返信中 → <a href='#note-" + id + "'>投稿#" + id + " <\a> ";
        cancelBtn.style.display = "inline";
        window.scrollTo({top: 0, behavior:"smooth"});
    });
});

cancelBtn.addEventListener("click", () => {
    replyInput.value = "";
    replyInfo.innerHTML = "";
    cancelBtn.style.display = "none";
});
</script>

{% endblock %}