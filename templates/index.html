{% extends "base.html" %}{% block content %}
<h2>Anonote -匿名すぎる掲示板-</h2>
<a href="/login">管理者ログイン</a>
<a href="/admin">管理者画面</a>
<a href="https://github.com/newhonke/Anonote">github</a>
{% if current_user.is_authenticated %}
<form action="{{ url_for('logout') }}" method="post" class="inline-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" class="link-button">ログアウト</button>
</form>
{% endif %}
<form action="/" method="post" class="post-form">
    <label>投稿</label>
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="text" name="note" required>
    <input type="hidden" name="reply_to" id="reply_to_input" value="">
    <div id="reply_info"></div>
    <button type="button" id="cancel_reply" style="display:none;">返信をキャンセル</button>
    <input type="submit" value="投稿">
</form>

<div class="timeline">
{% for note in notes %}
    <div id="note-{{ note.id }}" class="note" data-post-id="{{ note.id }}">
    <div class="time">
    {% if note.user and note.user.is_admin %}
        <p style="color: red;"><small>({{ note.created_at | to_jst }})</small></p>
    {% else %}
        <small>({{ note.created_at | to_jst }})</small>
    {% endif %}
    </div>

    <div class="reply">
    {% if note.reply_to %}
        {% set parent = parent_map.get(note.reply_to) %}
        {% if parent %}
            返信元:<a href="#note-{{ parent.id }}">{{ parent.post }}</a>
        {% endif %}
    {% endif %}
    </div>
    <div class="note-content">
    {% if note.renote_from_id %}
        <div class="renote">
        {% set original = parent_map.get(note.renote_from_id) %}
        {% if original %}
            <p class="renote-label">リノートされました</p>
            <blockquote>{{ original.post }}</blockquote>
        {% else %}
            <p>リノート元は削除されています</p>
        {% endif %}
        </div>
    {% else %}
        <p>{{ note.post }}</p>
    {% endif %}
    </div>
    
    {% if note.post and not note.renote_from_id %}
        <a href="#" class="reply-btn icon-btn" data-reply-to="{{ note.id }}"><i class="fa-solid fa-reply"></i></a>
        <form action="{{ url_for('renote', id=note.id) }}" method="post" class="inline-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="icon-btn" aria-label="リノート">
                <i class="fa-solid fa-retweet"></i>
            </button>
        </form>
    {% endif %}
    <span class="note-footer">
        <span class="reactions">
            {% for reaction in reactions[note.id] %}
                {% if reaction.emoji %}
                    <span data-emoji="{{ reaction.emoji.id }}">
                        <img src="{{ url_for('static', filename=reaction.emoji.image_url) }}"
                        alt="{{ reaction.emoji.name }}" width="34"> {{ reaction.count }}
                    </span>
                {% endif %}
            {% endfor %}
        </span>
        <a href="#" class="add-reaction icon-btn"><i class="fa-solid fa-plus"></i></a>
        <span class="emoji-picker hidden">
            {% for emoji in emojis %}
                <img src="{{ url_for('static', filename=emoji.image_url) }}"
                     class="emoji" data-id="{{ emoji.id }}"
                     alt="{{ emoji.name }}" width="24">
            {% endfor %}        
        </span>
    </span>
    </div>
{% else %}
<div class="not_note"><p>noteがありません。</p></div>    
{% endfor %}
</div>
{% endblock %}
